{
  "version": 1,
  "generated_at": "2025-12-30T21:08:51.729Z",
  "source_workspace": "C:\\Users\\chaim\\Documents\\UnityCredit 02",
  "proxy_target_ready_url": "http://unitybrein-env.eba-3bzvyngj.us-east-2.elasticbeanstalk.com",
  "handshake": {
    "required_headers": {
      "x-app-id": "<your-app-id>",
      "App-Key": "<shared-secret>"
    },
    "unity_credit_env": {
      "UNITY_BRAIN_OFFICE_URL": "http://unitybrein-env.eba-3bzvyngj.us-east-2.elasticbeanstalk.com",
      "UNITY_CREDIT_APP_ID": "unity-credit",
      "UNITY_CREDIT_APP_KEY": "change-me"
    },
    "unity_brain_env": {
      "UNITY_BRAIN_APP_KEYS_JSON": "{\"unity-credit\":\"change-me\"}"
    }
  },
  "api_contract": {
    "router": {
      "endpoint": "/v1/router",
      "method": "POST",
      "actions": [
        "finance.snapshot",
        "logic.process",
        "professional-advice"
      ],
      "payload_shape": {
        "action": "string",
        "payload": "any"
      }
    },
    "convenience_endpoints": [
      {
        "method": "POST",
        "path": "/v1/finance/snapshot"
      },
      {
        "method": "POST",
        "path": "/v1/logic/process"
      },
      {
        "method": "POST",
        "path": "/v1/professional-advice"
      },
      {
        "method": "GET",
        "path": "/v1/agents"
      }
    ],
    "upstream_ai": {
      "description": "Unity Brain calls the upstream AI service via HMAC-signed requests.",
      "endpoint": "/v1/execute-intelligence (upstream)"
    }
  },
  "included_files": [
    {
      "path": "unity-brain/core/prompts.ts",
      "bytes": 3368,
      "sha256": "20e134392df0e7f7fad542c2c2690a1a23e20456f0003f2920732b64a334c2be",
      "content": "// Unity Brain Core: prompt engineering + agent configuration lives here.\r\n\r\nexport type PromptKey = 'logic.process.system' | 'brain.optimize.system' | 'professional_advice.system'\r\n\r\nexport function agentConfig() {\r\n  return [\r\n    { id: 'node_1', role: 'Core Advisor', purpose: 'Primary answer generation' },\r\n    { id: 'node_2', role: 'Compliance/Safety', purpose: 'Policy + claims guardrails' },\r\n    { id: 'node_3', role: 'Budget Specialist', purpose: 'Heimishe budget grounding' },\r\n    { id: 'node_4', role: 'Evidence Checker', purpose: 'Sanity checks; flag missing facts' },\r\n    { id: 'node_5', role: 'Proofreader', purpose: 'Clarity + language correctness' },\r\n  ]\r\n}\r\n\r\nexport function promptCatalog() {\r\n  return {\r\n    agents: agentConfig(),\r\n    prompts: {\r\n      'logic.process.system': {\r\n        description: 'Main Unity Credit advice engine system prompt template.',\r\n        template: `You are Unity Credit's core engine.\r\n\r\nYou MUST:\r\n- Give practical, conservative savings advice.\r\n- Use the Heimishe Budget context (categories like Mikva, Schar Limud, Shabbos/Yom Tov, etc.) to ground suggestions.\r\n- Do NOT claim to pull credit reports or verify identity. This product does not pull credit reports.\r\n- IMPORTANT NUMERIC RULE: You are NOT allowed to do arithmetic. Do NOT compute totals, ratios, or deltas.\r\n  - Only quote numbers that already exist in the provided finance snapshot.\r\n  - If a user asks for a number that is not present in the finance snapshot, say you cannot compute it here.\r\n- End your response with the provided disclaimer line.\r\n\r\nFinance snapshot (authoritative output from ruleEngine; treat as read-only JSON):\r\n{{finance_snapshot_json}}\r\n\r\nTop budget categories (monthly; informational labels):\r\n{{top_budget_lines}}\r\n\r\nResponse language: {{response_language}}`,\r\n      },\r\n      'brain.optimize.system': {\r\n        description: 'Optimization engine system prompt (recurring bills).',\r\n        template: `You are Unity Credit's optimization engine.\r\n- Goal: identify practical, conservative savings opportunities based on recurring bills.\r\n- Output language: Yiddish (Heimishe style) inside the JSON fields (title_yi, email_subject_yi, email_body_yi, final).\r\n- Do NOT ask for sensitive personal info.\r\n- End the \"final\" string with the provided disclaimer line.`,\r\n      },\r\n      'professional_advice.system': {\r\n        description: 'Professional advice system prompt template.',\r\n        template: `You are a professional credit and financial advisor for Unity Credit.\r\n\r\nYour role:\r\n- Provide expert, accurate credit and financial advice\r\n- Help users understand credit scores, credit cards, debt management, and financial planning\r\n- Be empathetic, clear, and actionable in your responses\r\n- Always prioritize the user's financial well-being\r\n- If the question is in Yiddish, respond in fluent, natural Yiddish (Heimishe style as spoken in Chassidic communities)\r\n- If the question is in English, respond in professional English\r\n\r\nUser context:\r\n{{user_context}}\r\n\r\nGuidelines:\r\n- Be honest and transparent about credit and financial matters\r\n- Provide specific, actionable advice\r\n- Warn about potential risks when relevant\r\n- Encourage responsible credit management\r\n- Never provide investment advice (only credit/debt advice)\r\n- Always respond in {{response_language}}`,\r\n      },\r\n    } as const,\r\n  }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/core/ruleEngine.ts",
      "bytes": 5559,
      "sha256": "9eb0b56118e95eab3cf86e1386ff055a282dc0c1e79f21ddbb64abf2cbeaefa7",
      "content": "// ==========================================================\r\n// Unity Brain Core: Central Rule Engine (single source of truth)\r\n// - Savings + credit analysis formulas live here.\r\n// - Frontends must fetch computed outputs via the Unity Brain API.\r\n// ==========================================================\r\n\r\nexport type CreditCard = {\r\n  limit: number\r\n  balance: number\r\n}\r\n\r\nfunction clamp(n: number, min: number, max: number) {\r\n  return Math.max(min, Math.min(max, n))\r\n}\r\n\r\nfunction toFiniteNonNegativeNumber(v: any, fallback = 0) {\r\n  const n = Number(v)\r\n  if (!Number.isFinite(n) || n < 0) return fallback\r\n  return n\r\n}\r\n\r\nexport type CreditSummary = {\r\n  totalLimit: number\r\n  totalBalance: number\r\n  totalAvailable: number\r\n  utilizationPct: number // 0..100\r\n  payTo30: number\r\n}\r\n\r\nexport function computeCreditSummary(cards: CreditCard[]): CreditSummary {\r\n  const list = Array.isArray(cards) ? cards : []\r\n  let totalLimit = 0\r\n  let totalBalance = 0\r\n  for (const c of list) {\r\n    totalLimit += toFiniteNonNegativeNumber((c as any)?.limit, 0)\r\n    totalBalance += toFiniteNonNegativeNumber((c as any)?.balance, 0)\r\n  }\r\n  totalBalance = Math.min(totalBalance, totalLimit)\r\n  const totalAvailable = Math.max(0, totalLimit - totalBalance)\r\n  const utilizationPct = totalLimit > 0 ? clamp((totalBalance / totalLimit) * 100, 0, 100) : 0\r\n  const targetBalance = totalLimit * 0.3\r\n  const payTo30 = Math.max(0, totalBalance - targetBalance)\r\n  return { totalLimit, totalBalance, totalAvailable, utilizationPct, payTo30 }\r\n}\r\n\r\nexport type DebtRatioResult = {\r\n  debtRatio: number | null\r\n  debtRatioPct: number | null\r\n}\r\n\r\nexport function computeDebtRatio(params: { monthlyIncome: number | null | undefined; monthlyDebtPayments: number | null | undefined }): DebtRatioResult {\r\n  const income = params.monthlyIncome\r\n  const debt = params.monthlyDebtPayments\r\n  if (!Number.isFinite(income as any) || (income as number) <= 0) return { debtRatio: null, debtRatioPct: null }\r\n  if (!Number.isFinite(debt as any) || (debt as number) < 0) return { debtRatio: null, debtRatioPct: null }\r\n  const ratio = clamp((debt as number) / (income as number), 0, 10)\r\n  const pct = clamp(ratio * 100, 0, 1000)\r\n  return { debtRatio: ratio, debtRatioPct: pct }\r\n}\r\n\r\nexport function estimateMonthlyDebtPaymentsFromCreditCards(cards: CreditCard[], params?: { minPaymentPct?: number }) {\r\n  const list = Array.isArray(cards) ? cards : []\r\n  const minPaymentPct = Number.isFinite(params?.minPaymentPct as any) ? Number(params?.minPaymentPct) : 0.02\r\n  let total = 0\r\n  for (const c of list) {\r\n    const bal = toFiniteNonNegativeNumber((c as any)?.balance, 0)\r\n    if (bal <= 0) continue\r\n    total += bal * minPaymentPct\r\n  }\r\n  return total\r\n}\r\n\r\nexport type BankSnapshot = {\r\n  monthly_income?: number | null\r\n  monthly_expenses?: number | null\r\n  total_balance?: number | null\r\n  accounts_count?: number | null\r\n}\r\n\r\nexport type BudgetItemLike = {\r\n  monthly?: number | string | null\r\n}\r\n\r\nfunction parseNumberLike(v: any): number | null {\r\n  if (v === null || v === undefined) return null\r\n  const n = Number(v)\r\n  return Number.isFinite(n) ? n : null\r\n}\r\n\r\nexport function computeBudgetMonthlyTotalFromItems(items: BudgetItemLike[] | null | undefined) {\r\n  const list = Array.isArray(items) ? items : []\r\n  let total = 0\r\n  for (const it of list) {\r\n    const m = parseNumberLike((it as any)?.monthly)\r\n    if (!Number.isFinite(m as any) || (m as number) <= 0) continue\r\n    total += m as number\r\n  }\r\n  return total\r\n}\r\n\r\nexport type FinanceSnapshot = {\r\n  version: 1\r\n  generated_at: string\r\n  credit: CreditSummary | null\r\n  bank: {\r\n    total_balance: number | null\r\n    monthly_income: number | null\r\n    monthly_expenses: number | null\r\n    accounts_count: number | null\r\n  } | null\r\n  budget: { monthly_total: number | null } | null\r\n  derived: {\r\n    net_worth_estimate: number | null\r\n    est_monthly_debt_payments: number | null\r\n    debt_ratio_pct: number | null\r\n  } | null\r\n}\r\n\r\nexport function createFinanceSnapshot(params: { cards?: CreditCard[] | null; bank?: BankSnapshot | null; budget_items?: BudgetItemLike[] | null }): FinanceSnapshot {\r\n  const credit = params.cards ? computeCreditSummary(params.cards) : null\r\n  const bank = params.bank\r\n    ? {\r\n        total_balance: parseNumberLike(params.bank.total_balance),\r\n        monthly_income: parseNumberLike(params.bank.monthly_income),\r\n        monthly_expenses: parseNumberLike(params.bank.monthly_expenses),\r\n        accounts_count: parseNumberLike(params.bank.accounts_count),\r\n      }\r\n    : null\r\n\r\n  const budgetMonthlyTotal = computeBudgetMonthlyTotalFromItems(params.budget_items)\r\n  const budget = params.budget_items ? { monthly_total: budgetMonthlyTotal } : null\r\n\r\n  const estDebtPayments = credit ? estimateMonthlyDebtPaymentsFromCreditCards(params.cards || [], { minPaymentPct: 0.02 }) : null\r\n  const dr = computeDebtRatio({ monthlyIncome: bank?.monthly_income ?? null, monthlyDebtPayments: estDebtPayments })\r\n\r\n  const netWorthEstimate = typeof bank?.total_balance === 'number' && credit ? Number(bank.total_balance) - Number(credit.totalBalance) : null\r\n\r\n  return {\r\n    version: 1,\r\n    generated_at: new Date().toISOString(),\r\n    credit,\r\n    bank,\r\n    budget,\r\n    derived: {\r\n      net_worth_estimate: Number.isFinite(netWorthEstimate as any) ? (netWorthEstimate as number) : null,\r\n      est_monthly_debt_payments: Number.isFinite(estDebtPayments as any) ? (estDebtPayments as number) : null,\r\n      debt_ratio_pct: dr.debtRatioPct,\r\n    },\r\n  }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/brain-router.ts",
      "bytes": 4905,
      "sha256": "c9282a37617fc43d9b817778e8a8c6349cbd53b2699823ec5b1b21603856dba6",
      "content": "import type { Request, Response } from 'express'\r\nimport { z } from 'zod'\r\nimport { resolveModule } from './modules/registry.js'\r\n\r\ntype AppAuth = { ok: boolean; app_id: string; error?: string }\r\n\r\nfunction safeTrim(v: any) {\r\n  return String(v || '').trim()\r\n}\r\n\r\nfunction readHeader(req: any, name: string) {\r\n  const v = req.headers?.[name] || req.headers?.[name.toLowerCase()]\r\n  return safeTrim(Array.isArray(v) ? v[0] : v)\r\n}\r\n\r\nfunction parseAppKeysFromEnv(): Record<string, string> {\r\n  const raw = safeTrim(process.env.UNITY_BRAIN_APP_KEYS_JSON || '')\r\n  if (!raw) return {}\r\n  try {\r\n    const parsed = JSON.parse(raw)\r\n    if (!parsed || typeof parsed !== 'object') return {}\r\n    const out: Record<string, string> = {}\r\n    for (const [k, v] of Object.entries(parsed)) {\r\n      const kk = safeTrim(k).toLowerCase()\r\n      const vv = safeTrim(v)\r\n      if (kk && vv) out[kk] = vv\r\n    }\r\n    return out\r\n  } catch {\r\n    return {}\r\n  }\r\n}\r\n\r\nfunction verifyApp(req: any): AppAuth {\r\n  const app_id = readHeader(req, 'x-app-id') || readHeader(req, 'app-id') || 'unknown'\r\n  const provided = readHeader(req, 'app-key') || readHeader(req, 'x-app-key')\r\n  const keys = parseAppKeysFromEnv()\r\n  const expected = keys[String(app_id).toLowerCase()] || ''\r\n\r\n  // If no keys configured, fail closed in production; allow in dev for bootstrap.\r\n  const isProd = process.env.NODE_ENV === 'production'\r\n  if (!expected) {\r\n    if (isProd) return { ok: false, app_id, error: 'Unity Brain is missing app-key configuration (UNITY_BRAIN_APP_KEYS_JSON).' }\r\n    return { ok: true, app_id }\r\n  }\r\n  if (!provided) return { ok: false, app_id, error: 'Missing App-Key header.' }\r\n  if (provided !== expected) return { ok: false, app_id, error: 'Invalid App-Key.' }\r\n  return { ok: true, app_id }\r\n}\r\n\r\nconst routerReqSchema = z.object({\r\n  action: z.string().min(1),\r\n  payload: z.any().optional(),\r\n})\r\n\r\nexport function registerBrainRouter(app: any) {\r\n  // Universal router endpoint (module/agent dispatch). Works for any calling domain/app.\r\n  app.post('/v1/router', async (req: Request, res: Response) => {\r\n    const auth = verifyApp(req)\r\n    if (!auth.ok) return res.status(401).json({ ok: false, error: auth.error || 'Unauthorized', app_id: auth.app_id })\r\n\r\n    const parsed = routerReqSchema.safeParse(req.body || {})\r\n    if (!parsed.success) return res.status(400).json({ ok: false, error: 'Invalid payload', details: parsed.error.errors })\r\n\r\n    const { mod } = resolveModule(auth.app_id)\r\n    const reqHost = readHeader(req, 'host')\r\n    const ctx = { app_id: auth.app_id, user_id: null }\r\n\r\n    const action = parsed.data.action\r\n    const payload = parsed.data.payload\r\n\r\n    if (action === 'finance.snapshot') return res.json(mod.financeSnapshot(payload).json)\r\n    if (action === 'logic.process') {\r\n      const out = await mod.logicProcess(ctx, reqHost, payload)\r\n      return res.status(out.status).json(out.json)\r\n    }\r\n    if (action === 'professional-advice') {\r\n      const out = await mod.professionalAdvice(ctx, reqHost, payload)\r\n      return res.status(out.status).json(out.json)\r\n    }\r\n\r\n    return res.status(404).json({ ok: false, error: 'Unknown action' })\r\n  })\r\n\r\n  // Convenience endpoints (thin wrappers around /v1/router for common Unity Credit calls)\r\n  app.post('/v1/finance/snapshot', (req: Request, res: Response) => {\r\n    const auth = verifyApp(req)\r\n    if (!auth.ok) return res.status(401).json({ ok: false, error: auth.error || 'Unauthorized', app_id: auth.app_id })\r\n    const { mod } = resolveModule(auth.app_id)\r\n    const out = mod.financeSnapshot(req.body)\r\n    return res.status(out.status).json(out.json)\r\n  })\r\n\r\n  app.post('/v1/logic/process', async (req: Request, res: Response) => {\r\n    const auth = verifyApp(req)\r\n    if (!auth.ok) return res.status(401).json({ ok: false, error: auth.error || 'Unauthorized', app_id: auth.app_id })\r\n    const { mod } = resolveModule(auth.app_id)\r\n    const out = await mod.logicProcess({ app_id: auth.app_id, user_id: null }, readHeader(req, 'host'), req.body)\r\n    return res.status(out.status).json(out.json)\r\n  })\r\n\r\n  app.post('/v1/professional-advice', async (req: Request, res: Response) => {\r\n    const auth = verifyApp(req)\r\n    if (!auth.ok) return res.status(401).json({ ok: false, error: auth.error || 'Unauthorized', app_id: auth.app_id })\r\n    const { mod } = resolveModule(auth.app_id)\r\n    const out = await mod.professionalAdvice({ app_id: auth.app_id, user_id: null }, readHeader(req, 'host'), req.body)\r\n    return res.status(out.status).json(out.json)\r\n  })\r\n\r\n  app.get('/v1/agents', (req: Request, res: Response) => {\r\n    const auth = verifyApp(req)\r\n    if (!auth.ok) return res.status(401).json({ ok: false, error: auth.error || 'Unauthorized', app_id: auth.app_id })\r\n    const { mod } = resolveModule(auth.app_id)\r\n    return res.json({ ok: true, agents: mod.listAgents() })\r\n  })\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/modules/credit-module.ts",
      "bytes": 8876,
      "sha256": "38b71ee6fd287a773e84ecf6799b1e127949b77f70ce23270c81cfe5a5995c19",
      "content": "import { z } from 'zod'\r\nimport { promptCatalog } from '../core/prompts.js'\r\nimport { createFinanceSnapshot, computeCreditSummary } from '../core/ruleEngine.js'\r\nimport { executeUpstreamBrain } from '../src/brain/upstreamConnector.js'\r\nimport { createStorageClient } from '../storage/supabase.js'\r\n\r\nexport type CreditModuleContext = {\r\n  app_id: string\r\n  user_id: string | null\r\n}\r\n\r\nexport const creditAgentIds = ['node_1', 'node_2', 'node_3', 'node_4', 'node_5'] as const\r\n\r\nexport function listAgents() {\r\n  return promptCatalog().agents\r\n}\r\n\r\nconst financeSnapshotReqSchema = z.object({\r\n  cards: z.array(z.object({ limit: z.number(), balance: z.number() })).optional().nullable(),\r\n  bank: z\r\n    .object({\r\n      monthly_income: z.number().nullable().optional(),\r\n      monthly_expenses: z.number().nullable().optional(),\r\n      total_balance: z.number().nullable().optional(),\r\n      accounts_count: z.number().nullable().optional(),\r\n    })\r\n    .optional()\r\n    .nullable(),\r\n  budget_items: z.array(z.object({ monthly: z.union([z.number(), z.string()]).nullable().optional() })).optional().nullable(),\r\n})\r\n\r\nexport function financeSnapshot(body: any) {\r\n  const parsed = financeSnapshotReqSchema.safeParse(body || {})\r\n  if (!parsed.success) return { ok: false as const, status: 400, json: { ok: false, error: 'Invalid payload', details: parsed.error.errors } }\r\n  const snapshot = createFinanceSnapshot(parsed.data as any)\r\n  return { ok: true as const, status: 200, json: { ok: true, snapshot } }\r\n}\r\n\r\nconst logicProcessReqSchema = z.object({\r\n  question: z.string().min(1),\r\n  prefer_yiddish: z.boolean().optional(),\r\n  context: z\r\n    .object({\r\n      disclaimer_yi: z.string().optional(),\r\n      items: z.array(z.object({ key: z.string().optional(), yi: z.string().optional(), monthly: z.number().optional() })).optional(),\r\n      bank: z\r\n        .object({\r\n          monthly_income: z.number().nullable().optional(),\r\n          monthly_expenses: z.number().nullable().optional(),\r\n          total_balance: z.number().nullable().optional(),\r\n          accounts_count: z.number().nullable().optional(),\r\n        })\r\n        .nullable()\r\n        .optional(),\r\n    })\r\n    .passthrough()\r\n    .optional()\r\n    .nullable(),\r\n})\r\n\r\nfunction hasHebrew(text: string) {\r\n  return /[א-ת]/.test(text)\r\n}\r\n\r\nfunction safeTrim(v: any) {\r\n  return String(v || '').trim()\r\n}\r\n\r\nexport async function logicProcess(ctx: CreditModuleContext, reqHost: string, body: any) {\r\n  const parsed = logicProcessReqSchema.safeParse(body || {})\r\n  if (!parsed.success) return { ok: false as const, status: 400, json: { ok: false, error: 'Invalid payload', details: parsed.error.errors } }\r\n\r\n  const question = safeTrim(parsed.data.question)\r\n  const c = parsed.data.context || null\r\n  const disclaimer = safeTrim(c?.disclaimer_yi || '') || 'די דאטא ווערט געהאלטן פריוואט. מיר ציען נישט קיין קרעדיט רעפארטן.'\r\n  const preferYiddish =\r\n    typeof parsed.data.prefer_yiddish === 'boolean'\r\n      ? parsed.data.prefer_yiddish\r\n      : hasHebrew(question) || String(process.env.UNITY_PREFER_YIDDISH || 'true') === 'true'\r\n\r\n  const topItems =\r\n    Array.isArray((c as any)?.items) && (c as any).items.length > 0\r\n      ? (c as any).items\r\n          .filter((x: any) => Number(x?.monthly || 0) > 0)\r\n          .sort((a: any, b: any) => Number(b.monthly || 0) - Number(a.monthly || 0))\r\n          .slice(0, 12)\r\n      : []\r\n\r\n  const financeSnapshot = createFinanceSnapshot({\r\n    bank: (c as any)?.bank\r\n      ? {\r\n          monthly_income: typeof (c as any).bank.monthly_income === 'number' ? (c as any).bank.monthly_income : null,\r\n          monthly_expenses: typeof (c as any).bank.monthly_expenses === 'number' ? (c as any).bank.monthly_expenses : null,\r\n          total_balance: typeof (c as any).bank.total_balance === 'number' ? (c as any).bank.total_balance : null,\r\n          accounts_count: typeof (c as any).bank.accounts_count === 'number' ? (c as any).bank.accounts_count : null,\r\n        }\r\n      : null,\r\n    budget_items: Array.isArray((c as any)?.items) ? ((c as any).items as any) : null,\r\n  })\r\n\r\n  const system = `You are Unity Credit's core engine.\r\n\r\nYou MUST:\r\n- Give practical, conservative savings advice.\r\n- Use the Heimishe Budget context to ground suggestions.\r\n- Do NOT claim to pull credit reports or verify identity.\r\n- IMPORTANT NUMERIC RULE: You are NOT allowed to do arithmetic. Do NOT compute totals, ratios, or deltas.\r\n  - Only quote numbers that already exist in the provided finance snapshot.\r\n  - If a user asks for a number that is not present in the finance snapshot, say you cannot compute it here.\r\n- End your response with this exact Yiddish disclaimer line:\r\n${disclaimer}\r\n\r\nFinance snapshot (authoritative output from ruleEngine; treat as read-only JSON):\r\n${JSON.stringify(financeSnapshot)}\r\n\r\nTop budget categories (monthly; informational labels):\r\n${topItems.map((x: any) => `- ${x.yi || x.key}: $${Number(x.monthly || 0).toFixed(2)}`).join('\\n') || '- (none provided)'}\r\n\r\nResponse language: ${preferYiddish ? 'Yiddish (Heimishe style)' : 'English'}`\r\n\r\n  const core = await executeUpstreamBrain({\r\n    reqHost,\r\n    domain: 'savings',\r\n    question,\r\n    system,\r\n    disclaimer_yi: disclaimer,\r\n    prefer_yiddish: preferYiddish,\r\n    require_all_nodes: true,\r\n    category: 'Heimishe Budget',\r\n  })\r\n\r\n  if (!core.ok) return { ok: false as const, status: core.status, json: { ok: false, error: core.error, degraded: true } }\r\n  const j: any = core.json || {}\r\n  if (!j?.ok) return { ok: false as const, status: core.status, json: { ok: false, error: String(j?.error || 'Intelligence failed'), degraded: core.status >= 502 } }\r\n\r\n  // Central storage (best-effort): tag by app_id and user_id (if provided by gateway later).\r\n  try {\r\n    const db = createStorageClient()\r\n    if (db) {\r\n      await db.from('unity_brain.interactions').insert({\r\n        user_id: ctx.user_id,\r\n        app_id: ctx.app_id,\r\n        domain: 'savings',\r\n        kind: 'chat',\r\n        request_id: String((j as any)?.request_id || ''),\r\n        payload: { question, finance_snapshot: financeSnapshot, verification: j?.verification || null },\r\n      } as any)\r\n    }\r\n  } catch {\r\n    // ignore\r\n  }\r\n\r\n  return {\r\n    ok: true as const,\r\n    status: 200,\r\n    json: { ok: true, final: String(j.final || ''), verified: Boolean(j.verified ?? true), verification: j.verification || null, request_id: String((j as any).request_id || '') },\r\n  }\r\n}\r\n\r\nconst professionalAdviceReqSchema = z.object({\r\n  question: z.string().min(1),\r\n  cards: z.array(z.object({ limit: z.number(), balance: z.number() })).optional(),\r\n})\r\n\r\nexport async function professionalAdvice(ctx: CreditModuleContext, reqHost: string, body: any) {\r\n  const parsed = professionalAdviceReqSchema.safeParse(body || {})\r\n  if (!parsed.success) return { ok: false as const, status: 400, json: { ok: false, error: 'Invalid payload', details: parsed.error.errors } }\r\n\r\n  const question = safeTrim(parsed.data.question)\r\n  const cards = Array.isArray(parsed.data.cards) ? parsed.data.cards : []\r\n  const summary = cards.length ? computeCreditSummary(cards as any) : null\r\n  const context = summary\r\n    ? `User has ${cards.length} credit card(s). Total limit: $${summary.totalLimit.toFixed(2)}, total balance: $${summary.totalBalance.toFixed(\r\n        2\r\n      )}, utilization: ${summary.utilizationPct.toFixed(1)}%, available: $${summary.totalAvailable.toFixed(2)}.`\r\n    : 'No credit cards added yet.'\r\n\r\n  const isYiddish = hasHebrew(question)\r\n  const responseLanguage = isYiddish ? 'Yiddish (Heimishe style)' : 'English'\r\n\r\n  const system = `You are a professional credit and financial advisor for Unity Credit.\r\n\r\nUser's current credit situation: ${context}\r\n\r\nGuidelines:\r\n- Be honest and transparent about credit and financial matters\r\n- Provide specific, actionable advice\r\n- Never provide investment advice (only credit/debt advice)\r\n- Always respond in ${responseLanguage}`\r\n\r\n  const core = await executeUpstreamBrain({\r\n    reqHost,\r\n    domain: 'savings',\r\n    question,\r\n    system,\r\n    prefer_yiddish: isYiddish,\r\n    disclaimer_yi: 'די דאטא ווערט געהאלטן פריוואט. מיר ציען נישט קיין קרעדיט רעפארטן.',\r\n    require_all_nodes: true,\r\n    category: 'Professional Advice',\r\n  })\r\n\r\n  if (!core.ok) return { ok: false as const, status: core.status, json: { ok: false, error: core.error, degraded: true } }\r\n  const j: any = core.json || {}\r\n  if (!j?.ok) return { ok: false as const, status: core.status, json: { ok: false, error: String(j?.error || 'Advice failed'), details: j?.details } }\r\n\r\n  return { ok: true as const, status: 200, json: { ok: true, final: String(j?.final || ''), verified: Boolean(j?.verified ?? true), verification: j?.verification || null } }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/modules/registry.ts",
      "bytes": 466,
      "sha256": "6ccbe3c77af6dd22ac776564e8a3c167c6c84a9379604405036b7ae9d7b99a06",
      "content": "import * as credit from './credit-module.js'\r\n\r\nexport type BrainModuleId = 'unity-credit'\r\n\r\nexport function resolveModule(app_id: string) {\r\n  // Future expansion: map many app_ids to modules.\r\n  if (String(app_id || '').trim().toLowerCase() === 'unity-credit') return { id: 'unity-credit' as const, mod: credit }\r\n  // Default (safe): treat unknown app as unity-credit for now, but keep id explicit.\r\n  return { id: 'unity-credit' as const, mod: credit }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/storage/supabase.ts",
      "bytes": 458,
      "sha256": "900043bd3add1281b16cb7ec420888203c788c27da1c3a8c107c6273ce967068",
      "content": "import { createClient, type SupabaseClient } from '@supabase/supabase-js'\r\nimport { cfg } from '../src/config.js'\r\n\r\nexport function createStorageClient(): SupabaseClient | null {\r\n  const url = String(cfg.supabaseUrl || '').trim()\r\n  const key = String(cfg.supabaseServiceRoleKey || '').trim()\r\n  if (!url || !key) return null\r\n  return createClient(url, key, { auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false } })\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "unity-brain/storage/UNITY_BRAIN_GLOBAL_SCHEMA.sql",
      "bytes": 3008,
      "sha256": "fe621721fe10862683a561997772b1cd90ca44afab395fb6a2e12f15af6f24d4",
      "content": "-- Moved to /unity-brain/storage per architecture.\r\n-- This is the shared Supabase schema used across multiple domains.\r\n\r\n-- ==========================================================\r\n-- Unity Brain: Global shared schema (multi-domain)\r\n-- Run in Supabase SQL Editor.\r\n-- ==========================================================\r\n\r\ncreate schema if not exists unity_brain;\r\n\r\ncreate table if not exists unity_brain.interactions (\r\n  id uuid primary key default gen_random_uuid(),\r\n  user_id uuid references auth.users(id) on delete cascade,\r\n  app_id text not null,\r\n  domain text not null,\r\n  kind text not null default 'chat',\r\n  request_id text null,\r\n  payload jsonb not null,\r\n  created_at timestamptz not null default now()\r\n);\r\n\r\ncreate index if not exists unity_brain_interactions_user_created_idx\r\n  on unity_brain.interactions (user_id, created_at desc);\r\n\r\ncreate index if not exists unity_brain_interactions_kind_created_idx\r\n  on unity_brain.interactions (kind, created_at desc);\r\n\r\nalter table unity_brain.interactions enable row level security;\r\ndrop policy if exists \"Users read own interactions\" on unity_brain.interactions;\r\ncreate policy \"Users read own interactions\"\r\n  on unity_brain.interactions for select\r\n  using (auth.uid() = user_id);\r\n\r\ndrop policy if exists \"Users insert interactions\" on unity_brain.interactions;\r\ncreate policy \"Users insert interactions\"\r\n  on unity_brain.interactions for insert\r\n  with check (false);\r\n\r\ncreate table if not exists unity_brain.insights (\r\n  id uuid primary key default gen_random_uuid(),\r\n  user_id uuid references auth.users(id) on delete cascade,\r\n  app_id text not null,\r\n  domain text not null,\r\n  insight_key text not null,\r\n  payload jsonb not null,\r\n  created_at timestamptz not null default now(),\r\n  updated_at timestamptz not null default now()\r\n);\r\n\r\ncreate unique index if not exists unity_brain_insights_user_key_uq\r\n  on unity_brain.insights (user_id, insight_key);\r\n\r\ncreate index if not exists unity_brain_insights_user_updated_idx\r\n  on unity_brain.insights (user_id, updated_at desc);\r\n\r\nalter table unity_brain.insights enable row level security;\r\ndrop policy if exists \"Users read own insights\" on unity_brain.insights;\r\ncreate policy \"Users read own insights\"\r\n  on unity_brain.insights for select\r\n  using (auth.uid() = user_id);\r\n\r\ndrop policy if exists \"Users write insights\" on unity_brain.insights;\r\ncreate policy \"Users write insights\"\r\n  on unity_brain.insights for insert\r\n  with check (false);\r\n\r\ncreate table if not exists unity_brain.rulesets (\r\n  id uuid primary key default gen_random_uuid(),\r\n  ruleset_key text not null unique,\r\n  payload jsonb not null,\r\n  created_at timestamptz not null default now(),\r\n  updated_at timestamptz not null default now()\r\n);\r\n\r\nalter table unity_brain.rulesets enable row level security;\r\ndrop policy if exists \"No direct access rulesets\" on unity_brain.rulesets;\r\ncreate policy \"No direct access rulesets\"\r\n  on unity_brain.rulesets for select\r\n  using (false);\r\n\r\n\r\n"
    },
    {
      "path": "lib/unity-brain-office.ts",
      "bytes": 1376,
      "sha256": "94729f670f3024aedea6d71ad801fefc5f41c75c0426ce8c6e1474c453a3cf3a",
      "content": "import 'server-only'\r\n\r\nfunction safeTrim(v: any) {\r\n  return String(v || '').trim()\r\n}\r\n\r\nexport function unityBrainOfficeUrl(): string {\r\n  const url = safeTrim(process.env.UNITY_BRAIN_OFFICE_URL || process.env.UNITY_BRAIN_URL || process.env.BRAIN_API_URL || '')\r\n  return url\r\n}\r\n\r\nexport async function callUnityBrainOffice(params: { path: string; body: any; req?: Request }) {\r\n  const baseUrl = unityBrainOfficeUrl()\r\n  if (!baseUrl) {\r\n    return { ok: false as const, status: 503, error: 'Unity Brain Office is not configured. Set UNITY_BRAIN_OFFICE_URL.' }\r\n  }\r\n  const url = new URL(params.path, baseUrl)\r\n  const cookie = params.req?.headers?.get?.('cookie') || ''\r\n  const host = params.req?.headers?.get?.('host') || ''\r\n  const appId = safeTrim(process.env.UNITY_CREDIT_APP_ID || process.env.UNITY_APP_ID || 'unity-credit')\r\n  const appKey = safeTrim(process.env.UNITY_CREDIT_APP_KEY || '')\r\n\r\n  const resp = await fetch(url, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...(cookie ? { cookie } : {}),\r\n      ...(host ? { host } : {}),\r\n      'x-app-id': appId,\r\n      ...(appKey ? { 'App-Key': appKey } : {}),\r\n    },\r\n    body: JSON.stringify(params.body || {}),\r\n    cache: 'no-store',\r\n  })\r\n  const json = await resp.json().catch(() => ({}))\r\n  return { ok: resp.ok as const, status: resp.status, json }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "app/api/finance/snapshot/route.ts",
      "bytes": 1014,
      "sha256": "229a5de9950e1a300a7a3c0ec000a72652e01e052c8c447a0c9b8c90e0af3287",
      "content": "import { NextRequest, NextResponse } from 'next/server'\r\nimport { enforceRateLimit } from '@/lib/server-rate-limit'\r\nimport { callUnityBrainOffice } from '@/lib/unity-brain-office'\r\n\r\nexport const runtime = 'nodejs'\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const rl = await enforceRateLimit(req, 'API_REQUESTS')\r\n  if (!rl.allowed) return NextResponse.json({ ok: false, error: 'Too many requests' }, { status: 429, headers: rl.headers })\r\n\r\n  const body = (await req.json().catch(() => ({}))) as any\r\n  const forwarded = await callUnityBrainOffice({ path: '/v1/finance/snapshot', body, req: req as any })\r\n  if (!forwarded.ok) {\r\n    const msg = String((forwarded.json as any)?.error || 'Finance snapshot failed')\r\n    return NextResponse.json({ ok: false, error: msg }, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n  }\r\n  return NextResponse.json(forwarded.json, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "app/api/logic/process/route.ts",
      "bytes": 998,
      "sha256": "bb53d49258b08d34671126d2ef2aa8a316a25d7dbe38b4cb924028811a41a831",
      "content": "import { NextRequest, NextResponse } from 'next/server'\nimport { enforceRateLimit } from '@/lib/server-rate-limit'\nimport { callUnityBrainOffice } from '@/lib/unity-brain-office'\n\nexport const runtime = 'nodejs'\n\nexport async function POST(req: NextRequest) {\n  const rl = await enforceRateLimit(req, 'LOGIC_PROCESS')\n  if (!rl.allowed) return NextResponse.json({ error: 'Too many requests' }, { status: 429, headers: rl.headers })\n\n  const body = (await req.json().catch(() => ({}))) as any\n  const forwarded = await callUnityBrainOffice({ path: '/v1/logic/process', body, req: req as any })\n  if (!forwarded.ok) {\n    const msg = String((forwarded.json as any)?.error || 'Brain office request failed')\n    return NextResponse.json({ ok: false, error: msg, degraded: true }, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\n  }\n  return NextResponse.json(forwarded.json, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\n}"
    },
    {
      "path": "app/api/brain/optimize/route.ts",
      "bytes": 2677,
      "sha256": "fd02b2340e35f5a3cfc35f9e9f7289dae2c7f635967872dd489e9b0918a95818",
      "content": "import { NextRequest, NextResponse } from 'next/server'\r\nimport { enforceRateLimit } from '@/lib/server-rate-limit'\r\nimport { createClient } from '@/lib/supabase'\r\nimport { callUnityBrainOffice } from '@/lib/unity-brain-office'\r\n\r\nexport const runtime = 'nodejs'\r\n\r\nfunction bad(status: number, error: string, details?: any) {\r\n  return NextResponse.json({ ok: false, error, ...(details ? { details } : null) }, { status, headers: { 'Cache-Control': 'no-store' } })\r\n}\r\n\r\nfunction safeBills(v: any) {\r\n  const arr = Array.isArray(v) ? v : []\r\n  return arr\r\n    .slice(0, 120)\r\n    .map((b: any) => ({\r\n      merchant: sanitizeInput(String(b?.merchant || '')).trim().slice(0, 120),\r\n      category: sanitizeInput(String(b?.category || '')).trim().slice(0, 40),\r\n      occurrences: Math.max(0, Math.min(24, Number(b?.occurrences || 0) || 0)),\r\n      monthly_estimate: Math.max(0, Math.min(1_000_000, Number(b?.monthly_estimate || 0) || 0)),\r\n      last_date: sanitizeInput(String(b?.last_date || '')).trim().slice(0, 20) || undefined,\r\n    }))\r\n    .filter((b: any) => b.merchant && b.monthly_estimate > 0)\r\n}\r\n\r\nfunction extractJsonObject(text: string): any | null {\r\n  const t = String(text || '').trim()\r\n  if (!t) return null\r\n  try {\r\n    return JSON.parse(t)\r\n  } catch {\r\n    const m = t.match(/\\{[\\s\\S]*\\}/)\r\n    if (!m) return null\r\n    try {\r\n      return JSON.parse(m[0])\r\n    } catch {\r\n      return null\r\n    }\r\n  }\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const rl = await enforceRateLimit(req, 'OPTIMIZATION_RUNS')\r\n  if (!rl.allowed) return bad(429, 'Too many requests')\r\n\r\n  // Require an authenticated user (personal optimization only).\r\n  try {\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n    if (!user?.id) return bad(401, 'Unauthorized')\r\n  } catch {\r\n    return bad(401, 'Unauthorized')\r\n  }\r\n\r\n  const body = (await req.json().catch(() => ({}))) as any\r\n  const bills = safeBills(body?.bills)\r\n  const disclaimer_yi = String(body?.disclaimer_yi || '').trim() || 'די דאטא ווערט געהאלטן פריוואט. מיר ציען נישט קיין קרעדיט רעפארטן.'\r\n  if (!bills.length) return bad(400, 'Missing bills payload')\r\n\r\n  const forwarded = await callUnityBrainOffice({ path: '/v1/brain/optimize', body: { bills, disclaimer_yi }, req: req as any })\r\n  if (!forwarded.ok) return bad(forwarded.status, String((forwarded.json as any)?.error || 'Optimization failed'), (forwarded.json as any)?.details)\r\n  return NextResponse.json(forwarded.json, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "app/api/professional-advice/route.ts",
      "bytes": 3569,
      "sha256": "f31ded9a41aef4a59df7a388d5319aa17105ded7b59648f04e688329a6e2e8ae",
      "content": "import { NextRequest, NextResponse } from 'next/server'\r\nimport { createClient } from '@/lib/supabase'\r\nimport { adviceQuestionSchema } from '@/lib/validations'\r\nimport { sanitizeInput, createAuditLog } from '@/lib/security'\r\nimport { sanitizeUnityLogicPublicText } from '@/lib/sanitize'\r\nimport { creditCardRowSchema } from '@/lib/finance/types'\r\nimport { callUnityBrainOffice } from '@/lib/unity-brain-office'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Verify user is authenticated (in production this route is protected by auth)\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: 'נישט ערלויבט' }, { status: 401 })\r\n    }\r\n\r\n    const body = await request.json()\r\n    const validationResult = adviceQuestionSchema.safeParse(body)\r\n\r\n    if (!validationResult.success) {\r\n      return NextResponse.json(\r\n        { error: 'אומגילטיגע אינפּוט', details: validationResult.error.errors },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const sanitizedQuestion = sanitizeInput(validationResult.data.question)\r\n\r\n    // Context from user's credit cards (optional)\r\n    const { data: cards } = await supabase\r\n      .from('credit_cards')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n\r\n    createAuditLog(user.id, 'PRO_ADVICE_REQUEST', 'professional_advice', {\r\n      questionLength: sanitizedQuestion.length,\r\n    })\r\n\r\n    let context = ''\r\n    if (Array.isArray(cards) && cards.length > 0) {\r\n      const parsed = cards\r\n        .map((c: any) => creditCardRowSchema.safeParse(c))\r\n        .filter((r) => r.success)\r\n        .map((r) => (r as any).data)\r\n      context = JSON.stringify(parsed.map((c: any) => ({ limit: Number(c.limit) || 0, balance: Number(c.balance) || 0 })))\r\n    }\r\n\r\n    const isYiddish = /[א-ת]/.test(sanitizedQuestion)\r\n    const responseLanguage = isYiddish ? 'Yiddish (Heimishe style)' : 'English'\r\n\r\n    const forwarded = await callUnityBrainOffice({\r\n      path: '/v1/professional-advice',\r\n      body: {\r\n        question: sanitizedQuestion,\r\n        cards: (() => {\r\n          try {\r\n            const arr = JSON.parse(context || '[]')\r\n            return Array.isArray(arr) ? arr : []\r\n          } catch {\r\n            return []\r\n          }\r\n        })(),\r\n      },\r\n      req: request as any,\r\n    })\r\n    if (!forwarded.ok) {\r\n      return NextResponse.json(\r\n        { error: String((forwarded.json as any)?.error || 'סיסטעם־טעות. ביטע פרובירט נאכאמאל.') },\r\n        { status: forwarded.status }\r\n      )\r\n    }\r\n\r\n    const response = String((forwarded.json as any)?.final || '').trim() || 'אנטשולדיגט, עס איז נישט געלונגען צו שאפֿן א ענטפער.'\r\n\r\n    // Brand guard: never reveal internal vendor/model framing; keep it framed as Unity Credit + Nodes.\r\n    // (Even though this route is \"professional advice\", we keep a consistent public framing.)\r\n    return NextResponse.json({ response: sanitizeUnityLogicPublicText(response) })\r\n  } catch (error: any) {\r\n    console.error('Advice service error:', error)\r\n\r\n    let errorMessage = 'עס איז נישט געלונגען צו באקומען פראפעסיאנעלע עצה'\r\n    if (error.message?.includes('rate_limit')) {\r\n      errorMessage = 'צו פיל פראבען. ביטע פרובירט נאכאמאל שפעטער.'\r\n    }\r\n\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "app/api/unity-brain/v1/route.ts",
      "bytes": 3389,
      "sha256": "6c66f195ccb5331ee3dccb608652425a24c655dd1341e0776f5c4f2331ef0488",
      "content": "import { NextRequest, NextResponse } from 'next/server'\r\nimport { enforceRateLimit } from '@/lib/server-rate-limit'\r\nimport { sanitizeInput } from '@/lib/security'\r\nimport { appendVerificationAudit } from '@/lib/audit-trail'\r\nimport { readAdminSettings } from '@/lib/admin-settings'\r\nimport { callUnityBrainOffice } from '@/lib/unity-brain-office'\r\n\r\nexport const runtime = 'nodejs'\r\n\r\nfunction safeDomain(v: string) {\r\n  const s = String(v || '').trim().toLowerCase()\r\n  if (s === 'inventory') return 'inventory'\r\n  if (s === 'travel') return 'travel'\r\n  return 'savings'\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const rl = await enforceRateLimit(req, 'API_REQUESTS')\r\n  if (!rl.allowed) return NextResponse.json({ ok: false, error: 'Too many requests' }, { status: 429, headers: rl.headers })\r\n\r\n  const body = (await req.json().catch(() => ({}))) as any\r\n  const question = sanitizeInput(String(body?.question || '')).trim()\r\n  const system = String(body?.system || '').trim()\r\n  const domain = safeDomain(String(body?.domain || 'savings'))\r\n  const request_id = String(body?.request_id || '').trim() || `brain-${Date.now()}-${Math.random().toString(16).slice(2)}`\r\n  const disclaimer_yi = sanitizeInput(String(body?.disclaimer_yi || '')).trim() || 'די דאטא ווערט געהאלטן פריוואט. מיר ציען נישט קיין קרעדיט רעפארטן.'\r\n  const prefer_yiddish = Boolean(body?.prefer_yiddish ?? true)\r\n\r\n  if (!question || !system) {\r\n    return NextResponse.json({ ok: false, error: 'Missing question/system' }, { status: 400, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n  }\r\n\r\n  const settings = await readAdminSettings().catch(() => null)\r\n  const require_all_nodes =\r\n    typeof settings?.require_all_nodes === 'boolean' ? settings.require_all_nodes : String(process.env.UNITY_REQUIRE_ALL_NODES || 'true') === 'true'\r\n\r\n  try {\r\n    const forwarded = await callUnityBrainOffice({\r\n      path: '/v1/execute-intelligence',\r\n      body: { domain, question, system, request_id, disclaimer_yi, prefer_yiddish, require_all_nodes },\r\n      req: req as any,\r\n    })\r\n    if (!forwarded.ok) {\r\n      return NextResponse.json({ ok: false, error: (forwarded.json as any)?.error || 'Brain office error' }, { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n    }\r\n\r\n    const shaped = forwarded.json as any\r\n\r\n    // Persist audit trail (encrypted when configured) without internal categories.\r\n    await appendVerificationAudit({\r\n      request_id,\r\n      ok: Boolean(shaped.ok),\r\n      blocked: Boolean((shaped as any).blocked),\r\n      reason: shaped.ok ? null : (shaped as any).error,\r\n      domain,\r\n      verification: (shaped as any).verification || null,\r\n      source: 'unity_brain_master',\r\n    }).catch(() => null)\r\n\r\n    return NextResponse.json(\r\n      {\r\n        ...shaped,\r\n        request_id,\r\n      },\r\n      { status: forwarded.status, headers: { ...rl.headers, 'Cache-Control': 'no-store' } }\r\n    )\r\n  } catch (e: any) {\r\n    await appendVerificationAudit({ request_id, ok: false, blocked: true, reason: e?.message || 'Intelligence error', domain, source: 'unity_brain_master' }).catch(() => null)\r\n    return NextResponse.json({ ok: false, blocked: true, error: 'Intelligence error' }, { status: 500, headers: { ...rl.headers, 'Cache-Control': 'no-store' } })\r\n  }\r\n}\r\n\r\n\r\n"
    },
    {
      "path": "SUPABASE_DASHBOARD_SCALING_INDEXES.sql",
      "bytes": 925,
      "sha256": "924244cee52b5ef49fc3934efeb7abfe0b841705ae97ce85b42c42a1d6f21104",
      "content": "-- ==========================================================\r\n-- UnityCredit: Dashboard hot-path indexes (scale + latency)\r\n-- Run in Supabase SQL Editor (safe to re-run).\r\n-- ==========================================================\r\n\r\n-- Credit cards: dashboard frequently filters by user_id and orders by created_at.\r\ncreate index if not exists credit_cards_user_created_at_idx\r\n  on public.credit_cards (user_id, created_at desc);\r\n\r\n-- Savings events: monthly summary filters by (user_id, event_kind) with a created_at window.\r\ncreate index if not exists user_savings_events_user_kind_created_at_idx\r\n  on public.user_savings_events (user_id, event_kind, created_at desc);\r\n\r\n-- Savings snapshots: monthly summary filters by (user_id, kind) and orders by created_at.\r\ncreate index if not exists user_savings_snapshots_user_kind_created_at_idx\r\n  on public.user_savings_snapshots (user_id, kind, created_at desc);\r\n\r\n\r\n"
    },
    {
      "path": "SUPABASE_PLAID_TRANSACTIONS.sql",
      "bytes": 1742,
      "sha256": "17276cae21b9fed05d33993531b8ed60b609f7911aa867d0e43ad55a718371b4",
      "content": "-- ==========================================================\r\n-- UnityCredit: Plaid transactions (per-user, scalable)\r\n-- Run in Supabase SQL Editor.\r\n-- ==========================================================\r\n\r\ncreate extension if not exists pgcrypto;\r\n\r\ncreate table if not exists public.plaid_transactions (\r\n  id uuid primary key default gen_random_uuid(),\r\n  user_id uuid references auth.users(id) on delete cascade not null,\r\n  plaid_transaction_id text not null,\r\n  amount numeric not null,\r\n  currency text not null default 'usd',\r\n  name text null,\r\n  merchant_name text null,\r\n  category_primary text null,\r\n  category_detailed text null,\r\n  occurred_on date not null,\r\n  created_at timestamptz not null default now()\r\n);\r\n\r\n-- Dedupe per user + Plaid transaction id\r\ncreate unique index if not exists plaid_transactions_user_txid_uq\r\n  on public.plaid_transactions (user_id, plaid_transaction_id);\r\n\r\n-- Hot-path query patterns\r\ncreate index if not exists plaid_transactions_user_date_idx\r\n  on public.plaid_transactions (user_id, occurred_on desc);\r\n\r\ncreate index if not exists plaid_transactions_user_cat_date_idx\r\n  on public.plaid_transactions (user_id, category_primary, occurred_on desc);\r\n\r\ncreate index if not exists plaid_transactions_user_merchant_date_idx\r\n  on public.plaid_transactions (user_id, merchant_name, occurred_on desc);\r\n\r\nalter table public.plaid_transactions enable row level security;\r\n\r\ndrop policy if exists \"Users can view own plaid transactions\" on public.plaid_transactions;\r\ncreate policy \"Users can view own plaid transactions\"\r\n  on public.plaid_transactions for select\r\n  using (auth.uid() = user_id);\r\n\r\n-- Inserts should be service-role only (sync job). Do NOT add an insert policy.\r\n\r\n\r\n"
    },
    {
      "path": "SUPABASE_USER_SAVINGS.sql",
      "bytes": 2783,
      "sha256": "1ab607dbc083be3791611f4911a3dd59e689e02cf3ff4942f568da704e3cbd43",
      "content": "-- ==========================================================\r\n-- UnityCredit User Savings Storage (500k+ scale) — Supabase Postgres\r\n-- Run in Supabase SQL Editor\r\n-- ==========================================================\r\n\r\ncreate extension if not exists pgcrypto;\r\n\r\n-- Snapshot of a user's latest Unity Credit savings recommendations (no raw transactions).\r\ncreate table if not exists public.user_savings_snapshots (\r\n  id uuid primary key default gen_random_uuid(),\r\n  user_id uuid references auth.users(id) on delete cascade not null,\r\n  kind text not null default 'savings_finder',\r\n  payload jsonb not null,\r\n  created_at timestamptz not null default now()\r\n);\r\n\r\ncreate index if not exists user_savings_snapshots_user_created_idx\r\n  on public.user_savings_snapshots (user_id, created_at desc);\r\n\r\ncreate index if not exists user_savings_snapshots_kind_created_idx\r\n  on public.user_savings_snapshots (kind, created_at desc);\r\n\r\nalter table public.user_savings_snapshots enable row level security;\r\ndrop policy if exists \"Users can read own savings snapshots\" on public.user_savings_snapshots;\r\ncreate policy \"Users can read own savings snapshots\"\r\n  on public.user_savings_snapshots for select\r\n  using (auth.uid() = user_id);\r\n\r\n-- Inserts should be server-driven; you can enable user insert later if desired.\r\ndrop policy if exists \"Service role writes savings snapshots\" on public.user_savings_snapshots;\r\ncreate policy \"Service role writes savings snapshots\"\r\n  on public.user_savings_snapshots for insert\r\n  with check (false);\r\n\r\n-- Track when a user clicks \"apply\" on a recommendation (savings attribution).\r\ncreate table if not exists public.user_savings_events (\r\n  id uuid primary key default gen_random_uuid(),\r\n  user_id uuid references auth.users(id) on delete cascade not null,\r\n  event_kind text not null default 'apply',\r\n  monthly_savings int not null,\r\n  title_yi text not null,\r\n  category text null,\r\n  target_budget_key text null,\r\n  created_at timestamptz not null default now()\r\n);\r\n\r\ncreate index if not exists user_savings_events_user_created_idx\r\n  on public.user_savings_events (user_id, created_at desc);\r\n\r\ncreate index if not exists user_savings_events_created_idx\r\n  on public.user_savings_events (created_at desc);\r\n\r\nalter table public.user_savings_events enable row level security;\r\ndrop policy if exists \"Users can insert own savings events\" on public.user_savings_events;\r\ncreate policy \"Users can insert own savings events\"\r\n  on public.user_savings_events for insert\r\n  with check (auth.uid() = user_id);\r\n\r\ndrop policy if exists \"Users can read own savings events\" on public.user_savings_events;\r\ncreate policy \"Users can read own savings events\"\r\n  on public.user_savings_events for select\r\n  using (auth.uid() = user_id);\r\n\r\n\r\n"
    },
    {
      "path": "SUPABASE_RLS_GUARDRAILS.sql",
      "bytes": 5725,
      "sha256": "c3eb7844ab21f48c5f1ff2a859b0678e70084900c97c252d0499e2878e782004",
      "content": "-- ==========================================================\r\n-- UnityCredit RLS Guardrails (Security & Stability First)\r\n-- Goal: No authenticated user can ever read/write another user's data,\r\n--       and \"server-only\" tables remain inaccessible from anon/auth clients\r\n--       even if application logic makes a mistake.\r\n--\r\n-- Run in Supabase SQL Editor AFTER the base schema scripts.\r\n-- ==========================================================\r\n\r\n-- ---------- 1) User-scoped tables ----------\r\n\r\n-- Unity Brain interaction journal (encrypted payloads)\r\nalter table if exists public.unity_brain_interactions enable row level security;\r\nalter table if exists public.unity_brain_interactions force row level security;\r\n\r\ndrop policy if exists \"Users can read own brain interactions\" on public.unity_brain_interactions;\r\ncreate policy \"Users can read own brain interactions\"\r\n  on public.unity_brain_interactions for select\r\n  using (auth.uid() = user_id);\r\n\r\n-- Writes are server-driven; do not allow direct writes from anon/auth.\r\ndrop policy if exists \"No direct writes (unity_brain_interactions)\" on public.unity_brain_interactions;\r\ncreate policy \"No direct writes (unity_brain_interactions)\"\r\n  on public.unity_brain_interactions for all\r\n  using (false)\r\n  with check (false);\r\n\r\n\r\n-- Plaid transactions table (if enabled) should already have read-own policy.\r\n-- Keep inserts server-only unless you explicitly add an insert policy later.\r\nalter table if exists public.plaid_transactions enable row level security;\r\nalter table if exists public.plaid_transactions force row level security;\r\n\r\ndrop policy if exists \"Users can view own plaid transactions\" on public.plaid_transactions;\r\ncreate policy \"Users can view own plaid transactions\"\r\n  on public.plaid_transactions for select\r\n  using (auth.uid() = user_id);\r\n\r\n\r\n-- ---------- 2) Server-only tables ----------\r\n-- These tables contain operational, admin, or global intelligence data.\r\n-- We enable RLS + FORCE it, and explicitly deny anon/auth access.\r\n\r\ndo $$\r\nbegin\r\n  -- Optimization snapshots/catalog\r\n  execute 'alter table if exists public.optimization enable row level security';\r\n  execute 'alter table if exists public.optimization force row level security';\r\n  execute 'drop policy if exists \"No direct access (optimization)\" on public.optimization';\r\n  execute 'create policy \"No direct access (optimization)\" on public.optimization for all using (false) with check (false)';\r\n\r\n  -- Email delivery logs (admin-only)\r\n  execute 'alter table if exists public.email_logs enable row level security';\r\n  execute 'alter table if exists public.email_logs force row level security';\r\n  execute 'drop policy if exists \"No direct access (email_logs)\" on public.email_logs';\r\n  execute 'create policy \"No direct access (email_logs)\" on public.email_logs for all using (false) with check (false)';\r\n\r\n  -- Admin alert config (admin-only)\r\n  execute 'alter table if exists public.admin_alert_config enable row level security';\r\n  execute 'alter table if exists public.admin_alert_config force row level security';\r\n  execute 'drop policy if exists \"No direct access (admin_alert_config)\" on public.admin_alert_config';\r\n  execute 'create policy \"No direct access (admin_alert_config)\" on public.admin_alert_config for all using (false) with check (false)';\r\n\r\n  -- Emergency control (admin-only)\r\n  execute 'alter table if exists public.emergency_control enable row level security';\r\n  execute 'alter table if exists public.emergency_control force row level security';\r\n  execute 'drop policy if exists \"No direct access (emergency_control)\" on public.emergency_control';\r\n  execute 'create policy \"No direct access (emergency_control)\" on public.emergency_control for all using (false) with check (false)';\r\n\r\n  -- Unity deals library (global intelligence; admin/server-only)\r\n  execute 'alter table if exists public.unity_deals_library enable row level security';\r\n  execute 'alter table if exists public.unity_deals_library force row level security';\r\n  execute 'drop policy if exists \"No direct access (unity_deals_library)\" on public.unity_deals_library';\r\n  execute 'create policy \"No direct access (unity_deals_library)\" on public.unity_deals_library for all using (false) with check (false)';\r\n\r\n  -- Unity savings vault + knowledge assets (encrypted intelligence; admin/server-only)\r\n  execute 'alter table if exists public.unity_savings_vault enable row level security';\r\n  execute 'alter table if exists public.unity_savings_vault force row level security';\r\n  execute 'drop policy if exists \"No direct access (unity_savings_vault)\" on public.unity_savings_vault';\r\n  execute 'create policy \"No direct access (unity_savings_vault)\" on public.unity_savings_vault for all using (false) with check (false)';\r\n\r\n  execute 'alter table if exists public.unity_knowledge_assets enable row level security';\r\n  execute 'alter table if exists public.unity_knowledge_assets force row level security';\r\n  execute 'drop policy if exists \"No direct access (unity_knowledge_assets)\" on public.unity_knowledge_assets';\r\n  execute 'create policy \"No direct access (unity_knowledge_assets)\" on public.unity_knowledge_assets for all using (false) with check (false)';\r\n\r\n  -- Unity brain licenses (admin/server-only)\r\n  execute 'alter table if exists public.unity_brain_licenses enable row level security';\r\n  execute 'alter table if exists public.unity_brain_licenses force row level security';\r\n  execute 'drop policy if exists \"No direct access (unity_brain_licenses)\" on public.unity_brain_licenses';\r\n  execute 'create policy \"No direct access (unity_brain_licenses)\" on public.unity_brain_licenses for all using (false) with check (false)';\r\nend $$;\r\n\r\n\r\n"
    },
    {
      "path": "supabase-plaid-tokens-migration.sql",
      "bytes": 967,
      "sha256": "ac0171d7ef2efc602678e3d565f11d6b0eb2bfd833da9d49b84c0dab1fa87f22",
      "content": "-- UnityCredit: Plaid token storage (Supabase)\r\n-- Run this in Supabase Dashboard -> SQL Editor\r\n--\r\n-- SECURITY:\r\n-- - RLS enabled and NO policies are added.\r\n-- - This means only service-role (server) can read/write.\r\n-- - Tokens are stored encrypted-at-rest at the app layer when PLAID_TOKEN_ENC_KEY (or AUDIT_LOG_ENC_KEY) is set.\r\n\r\nCREATE EXTENSION IF NOT EXISTS pgcrypto;\r\n\r\nCREATE TABLE IF NOT EXISTS public.plaid_tokens (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  user_id UUID NULL REFERENCES auth.users(id) ON DELETE SET NULL,\r\n  item_id TEXT NOT NULL UNIQUE,\r\n  access_token_enc TEXT NOT NULL,\r\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\r\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\r\n);\r\n\r\nALTER TABLE public.plaid_tokens ENABLE ROW LEVEL SECURITY;\r\n\r\nCREATE INDEX IF NOT EXISTS idx_plaid_tokens_item_id ON public.plaid_tokens(item_id);\r\nCREATE INDEX IF NOT EXISTS idx_plaid_tokens_user_id ON public.plaid_tokens(user_id);\r\n\r\n\r\n"
    },
    {
      "path": "env.example",
      "bytes": 3340,
      "sha256": "2308be944f9b0442a073f93e868a0f98672711a66f4316f49e73cbe218a579cb",
      "content": "# Copy this file to .env.local and fill in your values\r\n\r\n# Supabase Configuration\r\n# Get these from: https://app.supabase.com/project/_/settings/api\r\nNEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url\r\nNEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key\r\nSUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key\r\n# App URL:\r\n# - Local: http://localhost:3000\r\n# - Vercel: set to your production domain (recommended), e.g. https://your-domain.com\r\nNEXT_PUBLIC_APP_URL=http://localhost:3000\r\n\r\n# Unity Brain (external secured intelligence service)\r\n# Server-to-server only. Do NOT expose these to the browser.\r\n# Production Brain URL (preferred):\r\nBRAIN_API_URL=https://your-brain.vercel.app\r\n# Backward-compatible (local/dev):\r\nUNITY_BRAIN_URL=http://localhost:4020\r\n\r\n# Central Office (unity-brain) URL (preferred for separating frontend from brain):\r\nUNITY_BRAIN_OFFICE_URL=http://localhost:4020\r\n\r\n# Unity Brain handshake (Unity Credit -> Unity Brain)\r\n# - Unity Credit will send: x-app-id=UNITY_CREDIT_APP_ID and App-Key=UNITY_CREDIT_APP_KEY\r\n# - Unity Brain validates it against UNITY_BRAIN_APP_KEYS_JSON\r\nUNITY_CREDIT_APP_ID=unity-credit\r\nUNITY_CREDIT_APP_KEY=change-me\r\nUNITY_BRAIN_APP_KEYS_JSON={\"unity-credit\":\"change-me\"}\r\n\r\n# Production token (preferred, 128-bit+):\r\nMASTER_BRAIN_KEY=replace-with-long-secret\r\n# Backward-compatible (optional):\r\nUNITY_BRAIN_KEY=replace-with-long-secret\r\n# Preferred name for the server-to-server handshake (kept server-side only).\r\n# If set, this is used instead of UNITY_BRAIN_KEY.\r\nUNITY_BRAIN_LICENSE_KEY=replace-with-long-secret\r\n# App identity header sent to Unity Brain (server-to-server).\r\nUNITY_APP_ID=UnityCredit-01\r\n# Optional override for the domain identity sent to Unity Brain (otherwise derives from Host header)\r\nUNITY_APP_DOMAIN=localhost:3000\r\n\r\n# Email (Resend) — required for Enterprise OTP + email alerts\r\n# NOTE: Do NOT commit real secrets. Put real values in .env.local only.\r\nRESEND_API_KEY=your_resend_api_key\r\nRESEND_FROM=\"Unity Credit <no-reply@yourdomain.com>\"\r\n\r\n# Bank Connection (Plaid)\r\nPLAID_CLIENT_ID=your_plaid_client_id\r\nPLAID_SECRET=your_plaid_secret\r\nPLAID_ENV=sandbox\r\nPLAID_REDIRECT_URI=\r\n\r\n# Dev-only toggles (never enable in production)\r\n# Skip middleware auth gating (development only)\r\nUNITYCREDIT_DEV_BYPASS_AUTH=false\r\n# Allow dashboard UI without DB/auth for local UI work (development only)\r\nNEXT_PUBLIC_DEV_GUEST_MODE=false\r\n\r\n# Optional external advice provider key (server-side only)\r\n# (Primary intelligence routes through the external Brain service; this key is optional.)\r\nEXTERNAL_ADVICE_PROVIDER_KEY=your_provider_api_key\r\n\r\n# Stripe Billing (Premium Trial → Subscription)\r\n# Required for real billing; if omitted, the app falls back to demo mode for investor demos.\r\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...\r\nSTRIPE_SECRET_KEY=sk_test_...\r\n# Webhook secret for /api/stripe/webhook (recommended for production)\r\nSTRIPE_WEBHOOK_SECRET=whsec_...\r\n# Stripe Price ID for your Premium subscription price (recurring monthly)\r\nSTRIPE_PREMIUM_PRICE_ID=price_...\r\n# Optional: return URL for the Stripe Customer Portal (defaults to /settings)\r\nSTRIPE_BILLING_PORTAL_RETURN_URL=http://localhost:3000/settings\r\n# Optional display/override values (cents)\r\nNEXT_PUBLIC_PREMIUM_PRICE_CENTS=4900\r\nPREMIUM_PRICE_CENTS=4900\r\nPREMIUM_CURRENCY=usd\r\n\r\n"
    }
  ]
}